<!doctype html><html lang=en-us><title>Unit testing non-determinstic functions | George Thomas</title><meta charset=utf-8><meta name=generator content="Hugo 0.111.1"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=https://geotho.github.io/css/index.css><link rel=stylesheet href=https://geotho.github.io/css/classes.css><link rel=canonical href=https://geotho.github.io/post/2017/2017-08-02-unittest-nondeterminism/><link rel=alternate type=application/rss+xml href title="George Thomas"><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css integrity=sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js integrity=sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js integrity=sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI crossorigin=anonymous onload=renderMathInElement(document.body)></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-66953349-2","auto"),ga("send","pageview"))</script><body><header class=icons><a href=https://geotho.github.io/>George Thomas</a><nav><a href=/about/>About</a>
<a href=/projects/>Projects</a></nav></header><article><header><h1>Unit testing non-determinstic functions</h1><time datetime=2017-08-02T00:00:00Z>August 02, 2017</time></header><p>A trend I&rsquo;ve noticed among whiteboard-coding type questions is to ask questions about randomness.</p><p>Examples of these questions are things like:</p><ul><li>pick a random element from an array.</li><li>given a method rand5() that returns a integer between 0 and 4 inclusive uniformly at random,
implement rand7().</li><li>implement randomOdd(int min, int max), which returns a random odd number between min and max.</li><li>implement randomPrime(int min, int max), which returns a random prime number between min and max.</li></ul><p>The popularity of these questions is partly because you won&rsquo;t find them on LeetCode or HackerRank. Because writing test cases is hard.</p><p>So how can you write tests for non-deterministic functions? Here are some thoughts.</p><h4 id=consider-deterministic-edge-cases>Consider deterministic edge cases</h4><p>What should randomOdd(2,4) return? Probably only ever <code>3</code>. So walk through your code
and make sure that is the case. Remember than <code>randInt(n)</code> (Java) and <code>rand.Intn(n)</code> (Go) both
return results in the range [0,n) i.e. the largest number it can return is <code>n-1</code>.</p><h4 id=make-your-function-deterministic>Make your function deterministic</h4><p>All standard library randomness sources allow you to seed them for deterministic output.
Your functions should also allow this. For example, if I were to write the <code>randomOdd</code> function
above, I would wrap it in a class and allow the user to specify the random source:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>RandomOdder</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>private</span> Random r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RandomOdder</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>r</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Random<span style=color:#f92672>();</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#a6e22e>RandomOdder</span><span style=color:#f92672>(</span>Random r<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span><span style=color:#f92672>.</span><span style=color:#a6e22e>r</span> <span style=color:#f92672>=</span> r<span style=color:#f92672>;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>randomOdd</span><span style=color:#f92672>(</span><span style=color:#66d9ef>int</span> min<span style=color:#f92672>,</span> <span style=color:#66d9ef>int</span> max<span style=color:#f92672>)</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ... uses this.r, not random.randInt directly.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>If I were writing in Go, I would probably create my own random interface:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Intner</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>RandomOdder</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>i</span> <span style=color:#a6e22e>Intner</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>r</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>RandomOdder</span>) <span style=color:#a6e22e>RandomOdd</span>(<span style=color:#a6e22e>min</span>, <span style=color:#a6e22e>max</span> <span style=color:#66d9ef>int</span>) <span style=color:#66d9ef>int</span> {
</span></span><span style=display:flex><span>  <span style=color:#75715e>// ... uses r.i, not rand.Intn
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span></code></pre></div><p>Note that here, <code>random.Source</code> already implements the <code>Intner</code> interface. So I
can pass one of those in directly.</p><p>The really nice part about this approach is that you can provide a totally determinstic
mock <code>Intner</code> e.g.:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NotAtAllRandomIntner</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>i</span> <span style=color:#a6e22e>NotAtAllRandomIntner</span>) <span style=color:#a6e22e>Intn</span>(<span style=color:#a6e22e>n</span> <span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>i</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then, when you write unit tests you can specify the output of the random source directly.</p><p>The issue with this is that you have coupled your unit test to the implementation of the function, rather than its interface. Changes to the function body may require changes to the tests, which is suboptimal. If mocking the random source is non-trivial they maybe just using a determinstic (i.e. consistently seeded) random generator is fine with some appropriate statistical tests.</p><h4 id=maybe-write-statistical-tests>Maybe write statistical tests</h4><p>Realise the distinction between &ldquo;unit testing randomness&rdquo; and &ldquo;unit testing code that uses randomness.&rdquo; Try to avoid testing the randomness of the random number generator.</p><p>Suppose you&rsquo;ve written a function which you think shuffles a list uniformly at random:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>Shuffle</span>(<span style=color:#a6e22e>xs</span> []<span style=color:#66d9ef>int</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>xs</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>r</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rand</span>.<span style=color:#a6e22e>Intn</span>(len(<span style=color:#a6e22e>xs</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>xs</span>[<span style=color:#a6e22e>i</span>], <span style=color:#a6e22e>xs</span>[<span style=color:#a6e22e>r</span>] = <span style=color:#a6e22e>xs</span>[<span style=color:#a6e22e>r</span>], <span style=color:#a6e22e>xs</span>[<span style=color:#a6e22e>i</span>]
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><a href=https://geotho.github.io/post/2018/2018-08-26-weighted-sampling/>Read on for how we might write a statistical test.</a></p></article></body></html>